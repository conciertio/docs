<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<meta name="description" content="Concierto, an orchestration tool">
<meta name="author" content="An Application Orchestration Tool">
<title>Concierto</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/github.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Concierto</h1>
<div class="details">
<span id="author" class="author">An Application Orchestration Tool</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#_motivation">Motivation</a></li>
<li><a href="#_implementation">Implementation</a></li>
<li><a href="#_usage">Usage</a></li>
<li><a href="#_flavour_of_commands">Flavour of Commands</a></li>
<li><a href="#_configuration_settings">Configuration Settings</a></li>
<li><a href="#_template_any_file">Template any File</a></li>
</ul>
</li>
<li><a href="#_application_structure">Application Structure</a>
<ul class="sectlevel2">
<li><a href="#_target_files">Target Files</a></li>
<li><a href="#_whats_available_for_templating">What&#8217;s Available for Templating?</a></li>
</ul>
</li>
<li><a href="#_details">Details</a>
<ul class="sectlevel2">
<li><a href="#_services">Services</a></li>
<li><a href="#_targets">Targets</a></li>
<li><a href="#_scenarios_and_roles">Scenarios and Roles</a></li>
</ul>
</li>
<li><a href="#_getting_started">Getting Started</a>
<ul class="sectlevel2">
<li><a href="#_prerequisites">Prerequisites</a></li>
</ul>
</li>
<li><a href="#_services_2">Services</a>
<ul class="sectlevel2">
<li><a href="#_build">Build</a></li>
<li><a href="#_push">Push</a></li>
<li><a href="#_pre_and_post_build">Pre and Post Build</a></li>
<li><a href="#_aiding_integration">Aiding Integration</a></li>
</ul>
</li>
<li><a href="#_deploy">Deploy</a>
<ul class="sectlevel2">
<li><a href="#_deploy_process">Deploy Process</a></li>
</ul>
</li>
<li><a href="#_hooks">Hooks</a></li>
<li><a href="#_extensions">Extensions</a></li>
<li><a href="#_future">Future</a></li>
<li><a href="#_funding">Funding</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction"><a class="link" href="#_introduction">Introduction</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Concierto manages a top-level git repository where an entire application defined as docker services (in git sub-repos for non trivial services) can be built and deployed. All configuration and versioning is in one place for multiple deployment targets.</p>
</div>
<div class="paragraph">
<p>Concierto is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A command line orchestration tool utilising docker and docker-compose (or podman and podman-compose).</p>
</li>
<li>
<p>A build tool for an application where an application is defined as multiple docker services.</p>
</li>
<li>
<p>A handy tool for managing many machines.</p>
</li>
<li>
<p>Good at deploying different versions of an application to different sets of machines.</p>
</li>
<li>
<p>Has a simple iteration and templating model with no magic or daemons, simply ssh from control to managed nodes.</p>
</li>
<li>
<p>The Spanish spelling of concerto, cos i was able to get conciert.io - which still doesn&#8217;t work, but hey &#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>This documentation assumes familiarity with docker, and docker-compose files, some scripting and a knowledge of Clojure for extensions.</em></p>
</div>
<div class="paragraph">
<p>There is a video tutorial <a href="https://www.conciert.io/starter.html">here</a> with LXD clusters.</p>
</div>
<div class="paragraph">
<p>Github <a href="https://github.com/conciertio">here</a></p>
</div>
<div class="sect2">
<h3 id="_motivation"><a class="link" href="#_motivation">Motivation</a></h3>
<div class="paragraph">
<p>I needed a tool that could be handed off to customers to build/deploy services, add machines and provide a complete overview of a system from a git repository with sub-repos. This had to be done by knowledgeable stakeholders, but not necessarily programmers or devops, that is, i could setup a system then provide this tool as an acceptance test and means of self management, as i stepped away.</p>
</div>
<div class="paragraph">
<p>For more info mail <a href="mailto:contact@conciert.io">contact@conciert.io</a></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
At time of writing, I haven&#8217;t frozen or documented any notion of a public api to be called by extensions or if I have extensions right (input welcome), until I do I&#8217;d say the project is in <strong>late alpha</strong>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_implementation"><a class="link" href="#_implementation">Implementation</a></h3>
<div class="paragraph">
<p>Concierto:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Is written in <a href="http://www.babashka.org">Babashka</a>, a fast starting dialect of Clojure.</p>
</li>
<li>
<p>Functions nicely on Mac and Linux clients. Although babashka functions on Windows, Concierto has not been tested there.</p>
</li>
<li>
<p>May be extended via Clojure.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>I haven&#8217;t tested it on the Mac for about a month so there may be issues I&#8217;m unaware of, but if there are they should be trivial.</em></p>
</div>
</div>
<div class="sect2">
<h3 id="_usage"><a class="link" href="#_usage">Usage</a></h3>
<div class="paragraph">
<p>The typical usage is to install the bootstrap "concierto" program in a bin dir and call &#8230;&#8203;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>concierto

COMMANDS
---------

scenarios       List scenarios
targets         List targets
machines        List machines
services        List services
gather          Show all defined attributes of target
ssh             Execute a command over set of machines
set             Set a variable in concierto.conf
unset           Unset a variable in concierto.conf
visit           Visit a machine by IP, specified by host, e.g. visit stage-api1
exec            Run a templated script locally
rexec           Run a templated script remotely over set of machines
template        Template a file, --in &lt;file&gt; --out &lt;file&gt;, otherwise prints to stdout
build all       Build all services listed in services/build.edn in order, --push to push
build role      Build all services referenced by role, --push to push
build           Build the service(s), --push to push
push            Push the built service to registry
deploy          Deploy over set of machines
lint            Check for inconsistencies
version         Current version, --tag show tag only

EXTENSIONS
----------

mycompany disk-size            Find disk usage for selected devices
demo lxd cluster-base-image    base Alpine with extras
demo lxd cluster-create        create a new cluster
demo lxd cluster-remove        remove cluster instance
demo lxd cluster-remove-all    remove all cluster instances
demo registry create           create a local registry


MACHINE SELECTION
-----------------

Select machines with --select &lt;key val&gt;* also &lt;key val&gt;*

e.g. concierto machines --select cluster us role api

ENVIRONMENT VARIABLES
---------------------

CONCIERTO_APP    set the app directory
CONCIERTO_SCENARIO set the scenario directory
CONCIERTO_TARGET set the target directory

SWITCHES
--------

--verbose (-v) switch on messages
--dry-run      print commands to execute
--role &lt;role&gt;  specify role when not included in machine selection
--json         output as json
--list         output as list
--debug        dump templated deploy into 'debug' dir

DEFAULTS
--------

The following variables may be set in config using the set command,
and are stored in  concierto.conf

scenario    - provide a default scenario
target      - provide a default target
engine      - provide a default engine; docker or podman (default docker)
extensions  - merge extensions (default true)
remote-exec - provide a path to a file that is executed remotely on deploy

e.g. concierto set scenario myscenario

For more info mail contact@conciert.io</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The extensions in the listing above come with the starter pack.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_flavour_of_commands"><a class="link" href="#_flavour_of_commands">Flavour of Commands</a></h3>
<div class="paragraph">
<p>Concierto provides the following functionality.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_settings"><a class="link" href="#_configuration_settings">Configuration Settings</a></h3>
<div class="literalblock">
<div class="content">
<pre>concierto set scenario tiered
concierto set target live
concierto set engine podman</pre>
</div>
</div>
<div class="paragraph">
<p>These are stored in concierto.conf.</p>
</div>
<div class="sect3">
<h4 id="_list_some_machines"><a class="link" href="#_list_some_machines">List some machines</a></h4>
<div class="literalblock">
<div class="content">
<pre>concierto machines --list ip --select role api cluster west
10.174.25.155
10.174.25.37
10.174.25.195</pre>
</div>
</div>
<div class="paragraph">
<p>or json &#8230;&#8203;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>concierto machines --json --select role db
[{"role":"db","cluster":"west","ip":"10.174.25.250","host":"west-db","added":"dynamically"}]</pre>
</div>
</div>
<div class="paragraph">
<p>or the default edn &#8230;&#8203;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>concierto machines --select role api
({:role :api, :cluster "west", :ip "10.174.25.155", :host "west-api1", :added "dynamically"}
{:role :api, :cluster "west", :ip "10.174.25.37", :host "west-api2", :added "dynamically"}
{:role :api, :cluster "west", :ip "10.174.25.195", :host "west-api3", :added "dynamically"})</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_build_and_deploy"><a class="link" href="#_build_and_deploy">Build and deploy</a></h4>
<div class="paragraph">
<p>Build all services in order based on sequence in services/build.edn, then deploy 3 tiers of service to live servers.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>concierto build all --push --target live
concierto deploy \
    --scenario tiered \
    --target live \
    --select \
        role db also \
        role api also \
        role balancer</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_arbitrary_ssh"><a class="link" href="#_arbitrary_ssh">Arbitrary ssh</a></h4>
<div class="literalblock">
<div class="content">
<pre>concierto ssh --target live --select role db -- uptime
east-db: 12:52:39 up 1 day,  4:44,  0 users,  load average: 0.79, 0.72, 0.70
west-db: 12:52:39 up 1 day,  4:44,  0 users,  load average: 0.79, 0.72, 0.70</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_remote_scripts"><a class="link" href="#_remote_scripts">Remote Scripts</a></h4>
<div class="paragraph">
<p>Upload and execute scripts, e.g. for a script file, defined in scripts/docker-login</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/usr/bin/env sh

podman login {{access.docker.registry.url}}:5000 \
     -u {{access.docker.registry.user}} -p {{access.docker.registry.secret}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run it remotely, but with pre upload templating per target &#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">concierto rexec --target live --select cluster west -- scripts/docker-login</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_template_any_file"><a class="link" href="#_template_any_file">Template any File</a></h3>
<div class="literalblock">
<div class="content">
<pre>echo "{% for m in machines %}
            {{m.host}} {% endfor %&gt;}" &gt; host.tmpl
    concierto template --select cluster west --in=host.tmpl -q

        west-api1
        west-api2
        west-api3
        west-balancer
        west-db</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_application_structure"><a class="link" href="#_application_structure">Application Structure</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Concierto is mostly a declarative tool where the layout of directories and files defines your cloud application; Concierto ties the various files together with Django inspired <a href="https://github.com/yogthos/Selmer">templating</a>.</p>
</div>
<div class="paragraph">
<p>Concierto revolves around the idea of <strong>services</strong> - code deployed as containers.</p>
</div>
<div class="paragraph">
<p>Concierto defines a machine <strong>role</strong> as a docker compose file. That is, if docker containers are instantiated with docker-compose X.yml then that machine fullfills role X. Machines are tagged with at least 1 role.</p>
</div>
<div class="paragraph">
<p>Roles are aggregated as <strong>scenarios</strong>. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a test scenario could apply machine limits; memory, cpu etc to running services, whereas a production scenario may be unlimited.</p>
</li>
<li>
<p>bronze, silver, gold service level scenarios</p>
</li>
<li>
<p>tiered roles over many machines, as opposed to a single machine and role (developer)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Scenarios allow flexibily switching sets of  docker-compose files, favouring declarative verbosity over embedding template logic for multiple variation.</p>
</div>
<div class="paragraph">
<p><strong>targets</strong> assemble and aggregate all data that will be subsequently used in the build/deploy or any other process that could be implemented by extensions.</p>
</div>
<div class="paragraph">
<p>For each concept; service, scenario and target there is a corresponding directory for specification.</p>
</div>
<div class="paragraph">
<p>Finally, Concierto may be extended with Clojure within the extensions directory, or by hooks via the hooks.clj file in the targets directory.</p>
</div>
<div class="paragraph">
<p>The typical structure is:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>.
├── extensions
│   ├── demo
│   │   ├── lxd
│   │   │   └── extend.clj
│   │   └── registry
│   │       └── extend.clj
│   └── mycompany
│       └── disksize
│           └── extend.clj
├── scenarios
│   ├── single
│   │   └── dev.yml
│   └── tiered
│       ├── api.yml
│       ├── balancer.yml
│       └── db.yml
├── services
│   ├── api
│   │   └── Dockerfile
│   ├── balancer
│   │   └── Dockerfile
│   ├── build.edn
│   ├── db
│   │   └── Dockerfile
│   └── python
│       └── Dockerfile
└── targets
    ├── live
    │   ├── access
    │   ├── globals.edn
    │   ├── hooks.clj
    │   ├── machines.clj
    │   └── services.edn
    ├── local
    │   ├── globals.edn
    │   ├── hooks.clj
    │   ├── machines.edn
    │   └── services.edn
    └── stage
        ├── access.edn
        ├── globals.edn
        ├── machines.clj
        └── services.edn</pre>
</div>
</div>
<div class="sect2">
<h3 id="_target_files"><a class="link" href="#_target_files">Target Files</a></h3>
<div class="paragraph">
<p>As you can see above the target is defined by some key files &#8230;&#8203;</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">access (or .clj/.edn)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A map with ssh credentials and registry details</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">globals (or .clj/.edn)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A map, general info to be substituted as ENV vars.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">machines (or .clj/.edn)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A sequence of machines, with their IP address, role, hostname and cluster, and any other searchable attributes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">services (or .clj/.edn)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A map of service images/versions for the target.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hooks.clj</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Clojure file with functions that are executed at critical moments during a deploy or other process. More info here <a href="#_hooks">Hooks</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If a file without a .clj or .edn extension is supplied it is run as a #! function, and must write the edn data format to stdout.</p>
</div>
<div class="paragraph">
<p>If a clj file is used it must supply a "source" function which returns a map or sequence as required.</p>
</div>
<div class="paragraph">
<p>These files will be described in <a href="#_details">Details</a>, but the basic functioning of Concierto is to aggregate all data generated from these files into a map (keyed by filename) for a given target and then use the data for templating during any subsequent process.</p>
</div>
</div>
<div class="sect2">
<h3 id="_whats_available_for_templating"><a class="link" href="#_whats_available_for_templating">What&#8217;s Available for Templating?</a></h3>
<div class="paragraph">
<p>The <strong>gather</strong> command provides the aggregation of data from the target files, including dynamic attributes created for clusters and machines. Thus, <strong>gather</strong> shows you exactly what&#8217;s available to work with in a template.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>concierto gather --select role db also role balancer</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">{:services
 {:alpine {:image "alpine:3.18"},
  :python {:image "mypy:1.0.0"},
  :db {:image "myredis:1.0.0"},
  :api {:image "myapi:1.0.0"},
  :balancer {:image "mybalancer:1.0.0"}},
 :globals {:DB_PASSWORD "superduper", :DB_PORT 6379, :API_PORT 8080, :BALANCER_PORT 9000, :BBVER "1.3.182"},
 :machines
 (({:role :db, :cluster "east", :ip "10.174.25.37", :host "east-db", :added "dynamically"}
   {:role :db, :cluster "west", :ip "10.174.25.119", :host "west-db", :added "dynamically"})
  ({:role :balancer, :cluster "east", :ip "10.174.25.7", :host "east-bal", :added "dynamically"}
   {:role :balancer, :cluster "west", :ip "10.174.25.99", :host "west-bal", :added "dynamically"})),
 :clusters
 {:east {:db "10.174.25.37", :api ("10.174.25.131" "10.174.25.189" "10.174.25.91"), :cluster-name "east"},
  :west {:db "10.174.25.119", :api ("10.174.25.128" "10.174.25.62" "10.174.25.100"), :cluster-name "west"}},
 :access
 {:ssh {:user "concierto", :port 22},
  :docker {:registry {:url "10.174.25.1:5000", :tls-verify false, :user "ritchie", :secret "ritchie"}}},
 :target "live"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Attribute <strong>:machines</strong> is different from the raw machines.edn. It&#8217;s a sequence of possible groups, selected by <strong>also</strong> clause. The default is a sequence of one group, multiple <strong>also</strong> will provide a sequence of sequences. Further, the dynamic attributes have been applied (see <a href="#_hooks">Hooks</a>)</p>
</div>
<div class="paragraph">
<p>Attribute <strong>:clusters</strong> is created by the hook function attr-cluster (see <a href="#_hooks">Hooks</a> for details).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
During deploy and hence within the role files, 2 further attributes are added, :machine and :cluster. Although all the information is calculated prior to deploy (exactly as the gather command displays), the looping through the machines per deploy requires each instance of :machine and :cluster detail to be added dynamically.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_details"><a class="link" href="#_details">Details</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_services"><a class="link" href="#_services">Services</a></h3>
<div class="paragraph">
<p>A service is the code you wish to deploy in a running container. All services in your app are defined in subdirectories of the top level <em>services</em> directory.</p>
</div>
<div class="paragraph">
<p>The meta data, however, is defined in services.edn <strong>per target</strong>. Here is a typical services.edn &#8230;&#8203;</p>
</div>
<div class="sect3">
<h4 id="_services_edn"><a class="link" href="#_services_edn">services.edn</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">{:alpine {:image "alpine:3.18"}
 :python {:image "mypy:1.0.0"}
 :db {:image "mydb:1.0.0"}
 :api {:image "myapi:1.0.0"}
 :balancer {:image "mybalancer:1.0.0"}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Thus each target can define different image versions, e.g. a live target will not run the same image versions as a stage target as staging by definition is the future of the app.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The service key, e.g. :db, is very important. The service key in the role files, and the service directory names must match the service key given in services.edn. The service keys tie the elements of the system together.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_substitution_example_services_edn"><a class="link" href="#_substitution_example_services_edn">Substitution example services.edn</a></h4>
<div class="paragraph">
<p>You may now reference the services.edn definition from a Dockerfile (e.g. in services/db/Dockerfile)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Dockerfile hljs" data-lang="Dockerfile">    FROM: {{services.alpine.image}}
    RUN apk add redis</code></pre>
</div>
</div>
<div class="paragraph">
<p>and calls to build, e.g.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>concierto build db</pre>
</div>
</div>
<div class="paragraph">
<p>will substitute alpine:3.18 appropriately as it builds mydb:1.0.0 locally.</p>
</div>
<div class="paragraph">
<p>See <a href="#_services_2">Services</a> instructions for details on building and pushing docker images.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Although Docker build has it&#8217;s own substitution mechanism, Concierto performs it&#8217;s substitutions pre-build, and attempts to provide the {{}} templating in every possible situation and doesn&#8217;t detract from existing forms when you wish to use them.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_non_standard_templating"><a class="link" href="#_non_standard_templating">Non Standard Templating?</a></h4>
<div class="paragraph">
<p>One potential negative is the fact your Dockerfiles have non-standard templating and you can&#8217;t build them independently. This can be solved by templating your Dockerfiles on the fly. e.g. &#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">concierto template  --in services/db/Dockerfile
FROM alpine:3.18

RUN apk add redis
ADD runner /runner
CMD [ "/runner" ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just redirect to a new Dockerfile and build, script it or add an extension to render a non issue.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_targets"><a class="link" href="#_targets">Targets</a></h3>
<div class="paragraph">
<p>A deployment target contains the machines and variables required to deploy an application successfully, for example to a given customer.</p>
</div>
<div class="paragraph">
<p>The targets directory contains sub-directories for each deployment target; target details are specified in a minimum of 4 files; access, machines, services and globals (as described here <a href="#_target_files">Target Files</a>)</p>
</div>
<div class="paragraph">
<p>Concierto will attempt to load a .clj file first (with a source function), fallback to a .edn file and if that does not exist the file name without extension is treated as a generic script. This allows you to get machines, globals or other resources declaratively or programmatically (from clojure or a #! script). A #! script must print valid edn to stdout.</p>
</div>
<div class="paragraph">
<p>The target data is related directly to templating via the top level file names:</p>
</div>
<div class="paragraph">
<p>services.edn data may be referenced in any template directly as</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{{services.KEY}}</pre>
</div>
</div>
<div class="paragraph">
<p>or globals.edn data as</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{{globals.KEY}}</pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, you may specify any other number of resource files in the target as either maps or sequences that you wish to look up in templating, so otherglobs.edn could be accessed as</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{{otherglobs.KEY}}</pre>
</div>
</div>
<div class="paragraph">
<p>by specifying the --resource &lt;list of resource files&gt; key on the command line like this</p>
</div>
<div class="literalblock">
<div class="content">
<pre>concierto deploy --select cluster stage --resource otherglobs</pre>
</div>
</div>
<div class="paragraph">
<p>Concierto will look for otherglobs.clj falling back to otherglobs.edn and make the Clojure datastructure available in your templating.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Each extra file you provide will increase load times.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_machines_edn"><a class="link" href="#_machines_edn">machines.edn</a></h4>
<div class="paragraph">
<p>Here&#8217;s an example of a minimal machines.edn file, which as you can see is a sequence of maps</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">({:role :api, :cluster "east", :ip "10.174.25.32", :host "east-api1"}
 {:role :api, :cluster "east", :ip "10.174.25.187", :host "east-api2"}
 {:role :api, :cluster "east", :ip "10.174.25.134", :host "east-api3"}
 {:role :balancer, :cluster "east", :ip "10.174.25.36", :host "east-bal"}
 {:role :db, :cluster "east", :ip "10.174.25.228", :host "east-db"}
 {:role :api, :cluster "west", :ip "10.174.25.155", :host "west-api1"}
 {:role :api, :cluster "west", :ip "10.174.25.170", :host "west-api2"}
 {:role :api, :cluster "west", :ip "10.174.25.200", :host "west-api3"}
 {:role :balancer, :cluster "west", :ip "10.174.25.9", :host "west-bal"}
 {:role :db, :cluster "west", :ip "10.174.25.3", :host "west-db"})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The minimum number of keys to specify a machine is as you can see; role, cluster, ip, host.</p>
</div>
<div class="paragraph">
<p>You may add any other attributes and they will be searchable from the --select clause on the command line.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
An :ssh key can can be defined to allow specific username/port combinations per machine overriding the target defined access details.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is a potential machines.clj file, where the machine list is coming from an extension, but it must return the minimum number of keys as specified above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(ns targets.live.machines
  (:require [extensions.demo.lxd.extend :as lxd]))


(defn source []
  (lxd/machine-list))</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_globals_edn"><a class="link" href="#_globals_edn">globals.edn</a></h4>
<div class="paragraph">
<p>Here is a typical globals.edn file &#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">{:DB_PASSWORD "superduper"
 :DB_PORT 6379
 :API_PORT 8080
 :BALANCER_PORT 9000}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may place any key in this file and reference it for any use, by using the file name "globals" as the top level key, e.g.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{{globals.DB_PASSWORD}}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_access_edn"><a class="link" href="#_access_edn">access.edn</a></h4>
<div class="paragraph">
<p>Contains mandatory keys if you want to deploy, here is a typical file &#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">{:ssh {:user "concierto" :port 22}
 :docker {:registry  {:url "10.174.25.1:5000"
                      :user "ritchie"
                      :secret "ritchie"}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s an example of an "access" script (i.e. without clj or edn ). Notice a script must write valid edn to stdout (target scripts may not be templated as they are the source of templates).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/usr/bin/env sh

registryIP=$(lxc network show lxdbr0 | awk '/ipv4.address/ {gsub(/\/24/,"");print $2}')

cat &lt;&lt;EOF
{:ssh {:user "concierto" :port 22}
 :docker {:registry  {:url "$registryIP:5000"
                      :tls-verify false
                      :user "ritchie"
                      :secret "ritchie"}}}
EOF</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Any file in the targets directory can be a #! script, just remove the extension and chmod +x.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_required_keys"><a class="link" href="#_required_keys">Required Keys</a></h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 1%;">
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">:ssh</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">:port and :user are both required, note, the global setting can be overwritten by the same keys per machine in the machines files.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">:docker</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">registry.url is required, other keys could be provided if you use them in other scripts, e.g. user,secret for a docker login</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_the_config_file"><a class="link" href="#_the_config_file">The Config File</a></h4>
<div class="paragraph">
<p>Each target directory can also contain a config file, concierto.conf, to override specific keys &#8230;&#8203;</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 71.4286%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">:remote-exec</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">supply path to a remote execution script for a deploy for a target</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">:engine</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Target can use specific container engine.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_scenarios_and_roles"><a class="link" href="#_scenarios_and_roles">Scenarios and Roles</a></h3>
<div class="paragraph">
<p>A scenario directory contains docker-compose yml files. Each yml file is known as a role, that is, a series of services which fullfill a function on a given machine. Each machine could have multiple roles (specified as a :role vector in machines.edn).</p>
</div>
<div class="paragraph">
<p>The yml files may be  <a href="https://github.com/yogthos/Selmer">templated</a> using attributes defined for the specified target.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">version: "3.7"
services:
  db:
    image: "{{services.db.image|registry}}"
    container_name: "redis"
    environment:
      DB_PASSWORD: {{globals.DB_PASSWORD}}
    ports:
      - "{{globals.DB_PORT}}:6379"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The registry filter in {{services.db.image|registry}} adds the registry defined in access.edn to urls when the service is pushed to the registry and when role file is deployed. Otherwise for local usage it returns an empty string allowing use of the local image.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
All of your compose file image specs should include the |registry filter.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A machine may have multiple roles specified by including a vector of roles in the machine spec in machines.edn, e.g. for an infrastructure machine you could specify {:role [:git :registry] &#8230;&#8203;. } (during iteration it is visited twice, once for the git role once for the registry)
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started"><a class="link" href="#_getting_started">Getting Started</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_prerequisites"><a class="link" href="#_prerequisites">Prerequisites</a></h3>
<div class="sect3">
<h4 id="_babashka"><a class="link" href="#_babashka">Babashka</a></h4>
<div class="paragraph">
<p>The concierto script and concierto.jar comprise the Concierto system, however they rely on a Clojure scripting environment called Babashka, Babashka is a single binary. To install it on Mac</p>
</div>
<div class="literalblock">
<div class="content">
<pre>brew install borkdude/brew/babashka</pre>
</div>
</div>
<div class="paragraph">
<p>To install on linux, as root</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -sLO https://raw.githubusercontent.com/babashka/babashka/master/install
chmod +x install
./install</code></pre>
</div>
</div>
<div class="paragraph">
<p>Download concierto, putting it in a directory with an executable PATH that is convenient for your system, e.g. ~/.local/bin, and make it executable</p>
</div>
<div class="literalblock">
<div class="content">
<pre>wget "https://www.conciert.io/release/concierto" -O ~/.local/bin/concierto
chmod +x ~/.local/bin/concierto</pre>
</div>
</div>
<div class="paragraph">
<p>In the directory you wish to make your concierto app dir, you may initalise the app dir with</p>
</div>
<div class="literalblock">
<div class="content">
<pre>concierto update</pre>
</div>
</div>
<div class="paragraph">
<p>The update command gets the latest Concierto jar file and puts it in ./concierto/concierto.jar. The notion here is that the jar file gets versioned with the rest of your app. The concierto command always runs the jar file from your application directory.</p>
</div>
<div class="paragraph">
<p>You should now be able to run concierto and get the command help.</p>
</div>
</div>
<div class="sect3">
<h4 id="_managed_nodes"><a class="link" href="#_managed_nodes">Managed Nodes</a></h4>
<div class="ulist">
<ul>
<li>
<p>Should have docker/podman installed.</p>
</li>
<li>
<p>Should have docker-compose, docker compose or podman-compose installed.</p>
</li>
<li>
<p>Should be accessible over ssh by public key by the user, and the user login should be a member of the docker group.</p>
</li>
<li>
<p>"docker login your-registry" should have been run on each node.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>e.g. the starter-pack base image is setup with the following cloud-init spec &#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">#cloud-config

groups:
  - sudo

users:
  - name: concierto
    gecos: Concierto Admin
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/sh
    homedir: /home/concierto
    groups: sudo
    lock_passwd: true
    ssh_pwauth: false
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCSsw46VCaFaKY7BqbsIKoI31sTCeAXw5KI/ZLdQzDVuTolm9Q1ksg3RuPUA45/FbhcR0Xo4/PMj2fBDUuZJBEJKgrpGAbcVvH9ZxjYtATw1P4lhzbKxDCG14VKAO51ziX/nC5gNUAXfJNP6a51lh/KpUeXWZuonaPkfS/v4ewnB4QfmlXlOd7LnR0M7O3thR4n+SA6+LQeHjPJWqyejCzy0EALXJ+Nh4TtCLSeZtHLIq9XZChBttjJfFO5lelhbCxXDwP0Mh6FZDB6VKTZavYlM+MRDl6/h6l484DcDI2Y7XgyVzbQoAhvA1ImkMraE5fhUdvlnQ5U1M1biPM/syWGz0K+gDjO9fKgMVDT+168Mw6fZkewdQytkGX29yrmWw4o04O7PBYhMSM0P7LMfxn7SSXd4QRIzSJBmMiMjuo6jgYLZP8z2tTYQIFrUgchZKyNBksNco+YmLBzX4zi650xAk4WuVPkL7ewlDi2xZq/8j+liEu8Nbkjenp2RYfP+G0= ritchie@blackdog

runcmd:
  - [ apk, add, openssh, podman, sudo, py3-pip ]
  - [ rc-update, add, sshd ]
  - [ pip3, install, podman-compose ]</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Obviously, the setup above is tailored to your requirements. There&#8217;s no need to use a "concierto" login etc.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_docker_registry"><a class="link" href="#_docker_registry">Docker Registry</a></h4>
<div class="ulist">
<ul>
<li>
<p>Each deployment target is assumed to have a docker registry defined using the <em>docker.registry</em> key in access.edn for a given target.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Check the <a href="https://www.conciert.io/starter.html">starter-pack</a> documentation for a video tutorial using LXD in the setup of a multiple cluster, service and tier application.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_services_2"><a class="link" href="#_services_2">Services</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_build"><a class="link" href="#_build">Build</a></h3>
<div class="paragraph">
<p>Concierto assumes that you have images in a docker registry that you deploy from. If your service images already exist in a docker registry then you may deploy from that registry without a build process.</p>
</div>
<div class="paragraph">
<p>However, if you require a build process, Concierto can help with some convention.  Given the service "db", then the following directory layout is assumed</p>
</div>
<div class="literalblock">
<div class="content">
<pre>services/
  db/
    Dockerfile</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Remember the service name must match with name of a service in the targets service.edn file.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On calling</p>
</div>
<div class="literalblock">
<div class="content">
<pre>concierto build db --target live</pre>
</div>
</div>
<div class="paragraph">
<p>Concierto will build your Dockerfile, templating any variables defined from the templates&#8217;s resource files. For example, typically your FROM directive in the Dockerfile will refer to an existing image in the target, e.g. lets say your base alpine image</p>
</div>
<div class="literalblock">
<div class="content">
<pre>FROM: {{services.alpine.image}}</pre>
</div>
</div>
<div class="paragraph">
<p>This is very useful as it keeps all your service versions versioned in a single file target/live/services.edn.</p>
</div>
<div class="paragraph">
<p>The docker image is built locally with the image name given in the services.edn file under, e.g. for service db</p>
</div>
<div class="literalblock">
<div class="content">
<pre>:db {:image "mydb:1.0.0"}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_push"><a class="link" href="#_push">Push</a></h3>
<div class="paragraph">
<p>If your build script creates the service image correctly, then a call to</p>
</div>
<div class="literalblock">
<div class="content">
<pre>concierto push db</pre>
</div>
</div>
<div class="paragraph">
<p>will push your image to the docker registry whose URL is provided as the <em>docker.registry.url</em> key in the access.edn file for your deployment.</p>
</div>
</div>
<div class="sect2">
<h3 id="_pre_and_post_build"><a class="link" href="#_pre_and_post_build">Pre and Post Build</a></h3>
<div class="paragraph">
<p>Your service directory can contain pre and post build scripts</p>
</div>
<div class="literalblock">
<div class="content">
<pre>services/
    db/
        pre_build
        Dockerfile
        post_build</pre>
</div>
</div>
<div class="paragraph">
<p>If these executable scripts exist (any language with #!/usr/bin/env mylang), Concierto will call them before building the Dockerfile and after. So, for example, if you need to download any resource and tidy up afterwards you may.</p>
</div>
<div class="paragraph">
<p>The pre and post build scripts are templated before execution from any of the targets resource files, and are run with the service directory.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The concierto template command is very useful within the pre_build/post_build scripts. It allows you to template files easily during build with all the target details available, e.g. in a pre_build
</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="content">
<pre>#!/usr/bin/env sh
concierto template --in nginx.tmpl --out nginx.conf</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_aiding_integration"><a class="link" href="#_aiding_integration">Aiding Integration</a></h3>
<div class="sect3">
<h4 id="_alternate_docker_file"><a class="link" href="#_alternate_docker_file">Alternate Docker file</a></h4>
<div class="paragraph">
<p>You may specify an alternative to Dockerfile on the command line by specifying --build-file, also --no-cache is available, e.g.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>concierto build X --build-file ConciertoDockerfile --no-cache</pre>
</div>
</div>
<div class="paragraph">
<p>This is useful when testing and you already have an existing Dockerfile in a service directory and you don&#8217;t want to tweak it to try out Concierto.</p>
</div>
</div>
<div class="sect3">
<h4 id="_env_files"><a class="link" href="#_env_files">Env Files</a></h4>
<div class="paragraph">
<p>Existing services will already have environment variables defined, and probably as env files.  Again, you probably don&#8217;t want to tweak existing files, so by creating a Docker env file within the service directory and referencing it from the role file Concierto will template it and deploy it with the role file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">version: "3.7"
services:
  api:
    image: "{{services.api.image|registry}}"
    container_name: "api"
    ports:
      - "8080:8080"
    env_file:
      - api.env</code></pre>
</div>
</div>
<div class="paragraph">
<p>Concierto looks for api.env in the root dir of the service. api.env should be an env file but presumably templated, and should exist in the service directory &#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">DB_HOST={{cluster.db}}
DB_PORT={{globals.DB_PORT}}
DB_PASSWORD={{globals.DB_PASSWORD}}
MY_HOST={{machine.host}}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Using env files has the nice property of syncing Concierto variables with the variables already in use by services.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy"><a class="link" href="#_deploy">Deploy</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Concierto deploy process is simply identifying a set of machines primarily by role, e.g.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>concierto deploy --select role api</pre>
</div>
</div>
<div class="paragraph">
<p>where api is the role, and then to restrict the set of machines further by adding, e.g. a cluster</p>
</div>
<div class="literalblock">
<div class="content">
<pre>concierto deploy --select role api cluster us</pre>
</div>
</div>
<div class="paragraph">
<p>The best way to test the machines set is simply to list them first &#8230;&#8203;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>concierto machines --select role api
concierto machines --select role api cluster us</pre>
</div>
</div>
<div class="paragraph">
<p>Further, you may examine what commands are actually to be executed by adding the --dry-run option &#8230;&#8203;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>concierto machines --select role api --dry-run</pre>
</div>
</div>
<div class="paragraph">
<p>A typical deploy of an entire cluster will be in, for example, three separate tiers, thus requiring 3 separate calls to Concierto.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>concierto deploy --select role data cluster us
concierto deploy --select role api cluster us
concierto deploy --select role balancer cluster us</pre>
</div>
</div>
<div class="paragraph">
<p>and then obviously packaging the sequence in a script, say deploy_cluster defined below &#8230;&#8203;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>#!/usr/bin/env bash
concierto deploy --select role data cluster $1
concierto deploy --select role api cluster $1
concierto deploy --select role balancer cluster $1</pre>
</div>
</div>
<div class="paragraph">
<p>so that you may</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./deploy_cluster us</pre>
</div>
</div>
<div class="paragraph">
<p>Thus, using the simple Concierto calls as plumbing and tieing them together as simple scripts is the envisaged way of using Concierto.</p>
</div>
<div class="sect2">
<h3 id="_deploy_process"><a class="link" href="#_deploy_process">Deploy Process</a></h3>
<div class="paragraph">
<p>Concierto loads all target attributes once per run, and iterates through the machines, creating temporary directories on your local machine for each IP. During this process it templates the role files, and environment files with machine and attribute data and deposits an executor script into the same directory. The executor scipt is what is acutally doing the work on the server during the deploy. The executor script is replaceable and templatable (this fact allows you to transfer any attribute for server side processing.)</p>
</div>
<div class="paragraph">
<p>Then each temporary machine directory is tarred up and scp&#8217;d to a unique tar file on the host in question and untarred. Then the embedded executor script is run which determines if docker or podman is installed  on the host, and executes compose on the given yml file as appropriate.</p>
</div>
<div class="paragraph">
<p>The default executor script is below &#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/usr/bin/env sh
role="{{machine.role|name}}"

composer=$(which docker-compose)
opts=""

if [ -z "$composer" ]
then
        composer=$(which podman-compose)
fi

if [ -z "$composer" ]
then
        composer="docker compose"
fi

{% if not access.docker.registry.tls-verify %}
pull_args="--podman-pull-args 'tls-verify=false'"
{% else %}
pull_args=""
{% endif %}

$composer -f $role.yml $pull_args pull 
$composer $opts -f $role.yml up --force-recreate --detach</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
During the deploy process, in addition to the attributes described by the <strong>gather</strong> command, Concierto adds the :machine key with all the details of the machine currently being processed. As can be seen above, that&#8217;s very important in the executor script.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, all the deploy temporaries are tidied up on your local machine, unless you use the --debug option of deploy which drops the fully templated files into the "debug" directory without uploading and execution.</p>
</div>
<div class="sect3">
<h4 id="_replacing_the_executor_script"><a class="link" href="#_replacing_the_executor_script">Replacing the Executor script</a></h4>
<div class="paragraph">
<p>The remote executor can be replaced by providing a :remote-exec key in the config file that is a path to an execution script. Obviously it has to do what&#8217;s done above but it could be in any language and have additions. For example, provisioning Babashka on each server with a Babashka executor script would be easy.</p>
</div>
<div class="paragraph">
<p>Extensions could replace the Executor script.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hooks"><a class="link" href="#_hooks">Hooks</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>hooks.clj files can be associated with targets, within them you may define the following hooks as functions:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">attr-cluster [cluster]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">called once per cluster with the cluster name. Creates the :clusters attribute.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">attr-machine [machine-data cluster-args]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Called once per machine with all machine-data and the cluster data returned by attr-cluster. Return value is merged with machine-data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">on-deploy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">called on deploy end</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The hooks.clj file is the primary method of generating dynamic attributes during a deploy. Note the attr-* hooks are evaluated early before deploy or build and you can see their output in concierto gather
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the example below, given a cluster name, the attr-cluster function find the db machine of the cluster and the api machines of the cluster, and creates keys which will be merged into the final attribute set under the :clusters key.</p>
</div>
<div class="paragraph">
<p>The attr-machine function receives the arguments generated by the attr-cluster function, so they can be employed in any dynamic attribute operations per machine.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(ns targets.live.hooks
  (:require [concierto.core :as core]))

(defn attr-cluster
  "Create dynamic attribute map 'clusters' and will add whatever is
   returned under the key cluster per cluster
   e.g. {:east {:db {} :api [] :west {:db {} :api []}"
  [cluster]
  (let [db (flatten (core/select-machines :role :db :cluster cluster))
        api (flatten (core/select-machines :role :api :cluster cluster))]
    {:db (:ip (first db))
     :api (map :ip api)
     :cluster-name cluster}))

(defn attr-machine
  "Merges return value into current machine values. "
  [_machine _cluster-data]
  {:added "dynamically"})


(defn on-deploy [args]
  (println "Deployed " args))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because you may want to share hooks between targets, you may place an hooks.clj file within the targets directory, and those hooks which are not overridden by hooks.clj in a targets/TARGET/hooks.clj file will be executed.</p>
</div>
<div class="paragraph">
<p>So, if all targets share the same hooks just add one hooks.clj file in the targets directory itself.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extensions"><a class="link" href="#_extensions">Extensions</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>New functionality to the command line may be added via Clojure extensions.</p>
</div>
<div class="paragraph">
<p>Because Concierto is driven from the command line, extensions add themselves to the command line by providing a typical Babashka Cli dispatch function, as the last function that is evaluated in the extend.clj file.</p>
</div>
<div class="paragraph">
<p>Typical structure:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>application_name
    ...
    extensions
        mycompany
            disksize
                extend.clj
        3rdparty
            some_ext
                extend.clj</pre>
</div>
</div>
<div class="paragraph">
<p>For example, here&#8217;s an extension that retrieves disk sizes for a given mount point &#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-clojure hljs" data-lang="clojure">(ns extensions.mycompany.disksize.extend
  (:require [concierto.core :as core]
            [clojure.string :as str]))

(defn- run [args machine-data _init]
  (let [ip (:ip machine-data)
        out (core/ssh-raw ip "df -h")]
    (-&gt;&gt; (core/string-seq out)
         (map (fn [l]
                (when (str/index-of l (first (:args args)))
                  (str  l "\n"))))
         (filter some?)
         (apply str))))


(defn dispatch-table []
  [{:cmds ["mycompany" "disk-size"] :fn #(core/with-machines %1 run)
    :help "Find disk usage for selected devices"}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the dispatch-table function is <strong>last</strong> to be evaluated (and returned) to the calling function, the extension is merged into the normal cli</p>
</div>
<div class="literalblock">
<div class="content">
<pre>EXTENSIONS
----------
mycompany disk-size       Find disk usage for db machines</pre>
</div>
</div>
<div class="paragraph">
<p>and running it provides the following output:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>concierto mycompany disk-size --select role db --prefix host -- /dev/fuse
Scenario: cluster, Target: simulation, Engine: podman
east-db devtmpfs                  4.0M         0      4.0M   0% /dev/fuse
west-db devtmpfs                  4.0M         0      4.0M   0% /dev/fuse</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_future"><a class="link" href="#_future">Future</a></h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Formalise extension API</p>
</li>
<li>
<p>Tests/specs now that dev is settling down.</p>
</li>
<li>
<p>Logging of process output.</p>
</li>
<li>
<p>Extensions added from the classpath. I&#8217;m not that familiar with Java packaging ecosystem so the extensions are probably a bit naive in the greater scheme of things.</p>
</li>
<li>
<p>More extension hook points. Hooks will require to be vectors of callbacks and extensions will need to be able to add their own callbacks, e.g. an extension will want to know if a deploy has been successful.</p>
</li>
<li>
<p>A server version, Clojure proper, that provides a REST API with client mimicing current api, providing permissioned access to multiple apps, and targets.</p>
</li>
<li>
<p>The ability to bake targets or pipe attributes into a deployment or other process could have merit in some situations, e.g.</p>
<div class="literalblock">
<div class="content">
<pre>concierto gather | concierto --read-target-from-stdin deploy
concierto gather --target blah &gt; baked_blah.edn
concierto --target baked_blah.edn deploy</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, in testing to create invariants to test against, or for performance if the aggregation of target files becomes expensive.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_funding"><a class="link" href="#_funding">Funding</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you&#8217;d like to fund/donate to this project, or to acquire my time as a freelancer, then Bitcoin is the best way to do it.</p>
</div>
<div class="paragraph">
<p>Shoot me an email at <a href="mailto:ritchie@conciert.io">ritchie@conciert.io</a> with request details.</p>
</div>
<div class="paragraph">
<p>Easy with the Bitcoin QR code &#8230;&#8203;</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="concierto_donation.jpg" alt="concierto donation">
</div>
</div>
<div class="paragraph">
<p>or the address &#8230;&#8203;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>1KjGyJ5DYSKSQCctqASRHTYWHV89oEYEjT</pre>
</div>
</div>
<div class="paragraph">
<p>Thanks!</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-09-22 18:01:26 -0300
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/languages/clojure.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/languages/bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/languages/dockerfile.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/languages/yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/languages/nginx.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code[data-lang]')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
</body>
</html>